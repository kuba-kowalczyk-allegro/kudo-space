# actionlint: allow-secrets VERCEL_ORG_ID VERCEL_PROJECT_ID VERCEL_TOKEN
name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref to deploy (defaults to master)
        required: true
        default: master

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    environment: production
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Pull Vercel environment
        run: npx --yes vercel pull --yes --environment=production --token="${{ env.VERCEL_TOKEN }}"

      - name: Build with Vercel
        run: npx --yes vercel build --prod --token="${{ env.VERCEL_TOKEN }}"

      - name: Deploy prebuilt output
        run: npx --yes vercel deploy --prebuilt --prod --token="${{ env.VERCEL_TOKEN }}"
